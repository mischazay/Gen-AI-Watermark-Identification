\resizebox{\textwidth}{!}{%
\begin{tikzpicture}[
    node distance=0.8cm,
    % Compact styles to fit within page margins
    embedding/.style={rectangle, draw, rounded corners, minimum width=1.8cm, minimum height=0.5cm, align=center, fill=blue!15, font=\scriptsize},
    extraction/.style={rectangle, draw, rounded corners, minimum width=1.8cm, minimum height=0.5cm, align=center, fill=green!15, font=\scriptsize},
    algorithm/.style={rectangle, draw, rounded corners, minimum width=2.2cm, minimum height=0.6cm, align=center, fill=yellow!20, font=\scriptsize},
    data/.style={rectangle, draw, rounded corners, minimum width=1.5cm, minimum height=0.5cm, align=center, fill=gray!10, font=\scriptsize},
    arrow/.style={->,>=stealth},
    section/.style={draw, rounded corners, fill=gray!5, inner sep=4pt}
]

% EMBEDDING PIPELINE
\node[section] (embedding_section) at (0,0) {
    \begin{tikzpicture}[node distance=0.6cm]
        % avoid title overlap
        \node[font=\scriptsize\bfseries] at (0,0.8) {Embedding Pipeline};
        
        % Row 1
        \node[data] (prompt) {Text Prompt};
        \node[embedding, right=of prompt] (clip_encoder) {CLIP\\Encoder};
        \node[data, right=of clip_encoder] (text_emb) {Text Emb.};
        
        % Row 2
        \node[data, below=of prompt] (watermark_bits) {256-bit WM};
        \node[algorithm, right=of watermark_bits] (diffusion) {WM Diffusion\\$ch=1, hw=8$};
        \node[algorithm, below=of diffusion] (encryption) {ChaCha20};
        
        % Row 3
        \node[algorithm, below=of encryption] (gaussian_shading) {Gaussian Shading\\$z_T^{(w)} = \Phi^{-1}(...)$};
        
        % Row 4
        \node[data, below=of gaussian_shading] (watermarked_latent) {WM Latent};
        % --- MODIFICATION 1: Reposition the U-Net node to align with Text Emb. ---
        \node[embedding] (unet) at (text_emb |- watermarked_latent) {U-Net\\50 steps};
        \node[embedding, right=of unet] (vae_dec) {VAE Dec.};
        
        % Final output
        \node[data, below=of vae_dec] (wm_image) {WM Image};
        
        \draw[arrow] (prompt) -- (clip_encoder);
        \draw[arrow] (clip_encoder) -- (text_emb);
        \draw[arrow] (watermark_bits) -- (diffusion);
        \draw[arrow] (diffusion) -- (encryption);
        \draw[arrow] (encryption) -- (gaussian_shading);
        \draw[arrow] (gaussian_shading) -- (watermarked_latent);
        \draw[arrow] (watermarked_latent) -- (unet);
        \draw[arrow] (text_emb.south) -- (unet.north);
        \draw[arrow] (unet) -- (vae_dec);
        \draw[arrow] (vae_dec) -- (wm_image);
    \end{tikzpicture}
};

% EXTRACTION PIPELINE 
\node[section, below=2cm of embedding_section] (extraction_section) {
    \begin{tikzpicture}[node distance=0.6cm]
        % avoid title overlap
        \node[font=\scriptsize\bfseries] at (0,0.8) {Extraction Pipeline};
        
        % Input processing
        \node[data] (attacked_input) {Test Image};
        \node[extraction, right=of attacked_input] (vae_encoder) {VAE Enc.};
        \node[data, right=of vae_encoder] (latent_repr) {Latent $z_0'$};
        
        % DDIM Inversion
        \node[algorithm, right=of latent_repr] (ddim_inversion) {DDIM Inversion\\50 steps};
        \node[data, below=of ddim_inversion] (estimated_latent) {Est. $z_T'$};

        % Watermark recovery
        \node[algorithm, left=of estimated_latent] (inverse_sampling) {Inverse\\Sampling};
        \node[extraction, left=of inverse_sampling] (decryption) {ChaCha20\\Dec.};
        \node[extraction, left=of decryption] (majority_voting) {Majority\\Vote};
        \node[data, below=of majority_voting] (extracted_watermark) {Extract. $s'$};

        % Evaluation
        \node[algorithm, right=of extracted_watermark] (ber_calculation) {BER Calc.};
        \node[data, right=of ber_calculation] (detection_result) {Pass/Fail};
        
        \draw[arrow] (attacked_input) -- (vae_encoder);
        \draw[arrow] (vae_encoder) -- (latent_repr);
        \draw[arrow] (latent_repr) -- (ddim_inversion);
        \draw[arrow] (ddim_inversion) -- (estimated_latent);
        \draw[arrow] (estimated_latent) -- (inverse_sampling);
        \draw[arrow] (inverse_sampling) -- (decryption);
        \draw[arrow] (decryption) -- (majority_voting);
        \draw[arrow] (majority_voting) -- (extracted_watermark);
        \draw[arrow] (extracted_watermark) -- (ber_calculation);
        \draw[arrow] (ber_calculation) -- (detection_result);
    \end{tikzpicture}
};

% Connect sections
\draw[arrow, thick] (embedding_section.south) -- (extraction_section.north);

\end{tikzpicture}
}